<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Bot Heatmap Manager</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #34495e;
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .heatmap-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        
        .heatmap-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .heatmap-card img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÅ Chess Bot Heatmap Manager</h1>
        
        <!-- Generation Section -->
        <div class="section">
            <h2>–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–µ–ø–ª–æ–≤–∏—Ö –∫–∞—Ä—Ç</h2>
            
            <div id="status"></div>
            
            <div class="form-group">
                <label for="botSelect">–ë–æ—Ç:</label>
                <select id="botSelect">
                    <option value="DynamicBot">DynamicBot</option>
                    <option value="StockfishBot">StockfishBot</option>
                    <option value="RandomBot">RandomBot</option>
                    <option value="AggressiveBot">AggressiveBot</option>
                    <option value="FortifyBot">FortifyBot</option>
                    <option value="EndgameBot">EndgameBot</option>
                    <option value="CriticalBot">CriticalBot</option>
                    <option value="TrapBot">TrapBot</option>
                    <option value="KingValueBot">KingValueBot</option>
                    <option value="NeuralBot">NeuralBot</option>
                    <option value="UtilityBot">UtilityBot</option>
                    <option value="PieceMateBot">PieceMateBot</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="phaseSelect">–ï—Ç–∞–ø –≥—Ä–∏:</label>
                <select id="phaseSelect">
                    <option value="all">–í—Å—è –≥—Ä–∞</option>
                    <option value="opening">–î–µ–±—é—Ç (1-15 —Ö–æ–¥—ñ–≤)</option>
                    <option value="middlegame">–ú—ñ—Ç–µ–ª—å—à–ø—ñ–ª—å (16-40 —Ö–æ–¥—ñ–≤)</option>
                    <option value="endgame">–ï–Ω–¥—à–ø—ñ–ª—å (41+ —Ö–æ–¥—ñ–≤)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="pieceSelect">–¢–∏–ø —Ñ—ñ–≥—É—Ä–∏:</label>
                <select id="pieceSelect">
                    <option value="all">–í—Å—ñ —Ñ—ñ–≥—É—Ä–∏</option>
                    <option value="pawn">–ü—ñ—à–∞–∫–∏</option>
                    <option value="knight">–ö–æ–Ω—ñ</option>
                    <option value="bishop">–°–ª–æ–Ω–∏</option>
                    <option value="rook">–¢—É—Ä–∏</option>
                    <option value="queen">–§–µ—Ä–∑—ñ</option>
                    <option value="king">–ö–æ—Ä–æ–ª—ñ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="gamesLimit">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–≥–æ—Ä:</label>
                <input type="number" id="gamesLimit" value="100" min="1" max="1000">
            </div>
            
            <button onclick="generateHeatmap()">–ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–µ–ø–ª–æ–≤—É –∫–∞—Ä—Ç—É</button>
            <button onclick="generateAllHeatmaps()">–ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –≤—Å—ñ —Ç–µ–ø–ª–æ–≤—ñ –∫–∞—Ä—Ç–∏</button>
            <button onclick="loadHeatmaps()">–û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
        </div>
        
        <!-- Analysis Section -->
        <div class="section">
            <h2>–ê–Ω–∞–ª—ñ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤</h2>
            <button onclick="analyzeBot()">–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –±–æ—Ç–∞</button>
            <button onclick="compareBots()">–ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ –±–æ—Ç—ñ–≤</button>
        </div>
        
        <!-- Heatmaps Display -->
        <div class="section">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ñ —Ç–µ–ø–ª–æ–≤—ñ –∫–∞—Ä—Ç–∏</h2>
            <div id="heatmapGrid" class="heatmap-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="section">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div id="stats" class="stats">
                <!-- Stats will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Robust API base: supports both file:// and http(s) contexts
        const API_BASE = (typeof window !== 'undefined' && typeof window.API_BASE === 'string' && window.API_BASE.trim())
            ? window.API_BASE.trim()
            : (location.protocol.startsWith('http') ? '/api' : 'http://127.0.0.1:5000/api');
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showLoading(show = true) {
            const grid = document.getElementById('heatmapGrid');
            if (show) {
                grid.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–µ–ø–ª–æ–≤–æ—ó –∫–∞—Ä—Ç–∏...</p>
                    </div>
                `;
            }
        }
        
        async function generateHeatmap() {
            const bot = document.getElementById('botSelect').value;
            const phase = document.getElementById('phaseSelect').value;
            const piece = document.getElementById('pieceSelect').value;
            const games = document.getElementById('gamesLimit').value;
            
            showLoading(true);
            showStatus('–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–µ–ø–ª–æ–≤–æ—ó –∫–∞—Ä—Ç–∏...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/heatmaps/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bot_name: bot,
                        game_phase: phase,
                        piece_type: piece,
                        games_limit: parseInt(games)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`‚úì –¢–µ–ø–ª–æ–≤–∞ –∫–∞—Ä—Ç–∞ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∞! –§–∞–π–ª: ${result.result.filepath}`, 'success');
                    loadHeatmaps();
                } else {
                    showStatus(`‚úó –ü–æ–º–∏–ª–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚úó –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function generateAllHeatmaps() {
            if (!confirm('–ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–µ–ø–ª–æ–≤—ñ –∫–∞—Ä—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö –±–æ—Ç—ñ–≤? –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –±–∞–≥–∞—Ç–æ —á–∞—Å—É.')) {
                return;
            }
            
            showLoading(true);
            showStatus('–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤—Å—ñ—Ö —Ç–µ–ø–ª–æ–≤–∏—Ö –∫–∞—Ä—Ç...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/heatmaps/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bot_name: 'all',
                        game_phase: 'all',
                        piece_type: 'all',
                        games_limit: 100
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`‚úì –í—Å—ñ —Ç–µ–ø–ª–æ–≤—ñ –∫–∞—Ä—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ!`, 'success');
                    loadHeatmaps();
                } else {
                    showStatus(`‚úó –ü–æ–º–∏–ª–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚úó –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadHeatmaps() {
            try {
                const response = await fetch(`${API_BASE}/heatmaps`);
                const data = await response.json();
                
                const grid = document.getElementById('heatmapGrid');
                
                if (data.heatmaps && data.heatmaps.length > 0) {
                    grid.innerHTML = data.heatmaps.map(heatmap => `
                        <div class="heatmap-card">
                            <h3>${heatmap.name}</h3>
                            <p><strong>–§–∞–π–ª:</strong> ${heatmap.filename}</p>
                            <p><strong>–†–æ–∑–º—ñ—Ä:</strong> ${(heatmap.size / 1024).toFixed(1)} KB</p>
                            <p><strong>–ó–º—ñ–Ω–µ–Ω–æ:</strong> ${new Date(heatmap.modified * 1000).toLocaleString()}</p>
                            <img src="${API_BASE}/heatmaps/${heatmap.filename}" alt="${heatmap.name}" 
                                 onerror="this.style.display='none'">
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p>–¢–µ–ø–ª–æ–≤—ñ –∫–∞—Ä—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ —ó—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ñ–æ—Ä–º—É –≤–∏—â–µ.</p>';
                }
            } catch (error) {
                const hint = (API_BASE.startsWith('http') ? ` –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ —Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ ${API_BASE.replace(/\/api$/, '')}.` : ' –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä –∑–∞ –∞–¥—Ä–µ—Å–æ—é http://127.0.0.1:5000/heatmaps.');
                document.getElementById('heatmapGrid').innerHTML = 
                    `<p style="color: red;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}.${hint}</p>`;
            }
        }
        
        async function analyzeBot() {
            const bot = document.getElementById('botSelect').value;
            
            try {
                const response = await fetch(`${API_BASE}/heatmaps/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bot_name: bot,
                        piece_type: 'all'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`‚úì –ê–Ω–∞–ª—ñ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –¥–ª—è ${bot}`, 'success');
                    console.log('Analysis result:', result.analysis);
                } else {
                    showStatus(`‚úó –ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‚úó –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`, 'error');
            }
        }
        
        async function compareBots() {
            showStatus('–§—É–Ω–∫—Ü—ñ—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –±–æ—Ç—ñ–≤ –±—É–¥–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó', 'info');
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–µ–ø–ª–æ–≤—ñ –∫–∞—Ä—Ç–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            loadHeatmaps();
        });
    </script>
</body>
</html>