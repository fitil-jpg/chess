<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chess AI Dashboard</title>
  <style>
    :root {
      --bg: #0f1221;
      --panel: #171b31;
      --panel-2: #1e2340;
      --text: #e8eaf6;
      --muted: #9aa0b6;
      --accent: #7c4dff;
      --accent-2: #00e5ff;
      --good: #2ecc71;
      --bad: #e74c3c;
      --board-a: #b58863;
      --board-b: #f0d9b5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(124,77,255,0.08), transparent 60%),
                  radial-gradient(900px 700px at -10% 110%, rgba(0,229,255,0.08), transparent 60%),
                  var(--bg);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px; border-bottom: 1px solid #2a2f54; background: linear-gradient(180deg, #131836, #111630);
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: 0.3px; }
    header .actions { display: flex; gap: 10px; }
    button {
      background: linear-gradient(135deg, var(--accent), #5b35ff);
      color: white; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600;
      box-shadow: 0 6px 20px rgba(124,77,255,0.35), inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    button.secondary { background: linear-gradient(135deg, #2d335c, #23294b); color: #e0e3ff; }
    button.ghost { background: transparent; border: 1px solid #2d335c; color: #c7cbf6; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .layout {
      display: grid; grid-template-columns: 280px 1fr 360px; gap: 16px; padding: 16px; align-items: start;
    }
    .panel { background: var(--panel); border: 1px solid #23294b; border-radius: 14px; padding: 14px; }
    .panel h2 { font-size: 14px; font-weight: 700; margin: 0 0 10px; color: #c7cbf6; letter-spacing: 0.2px; }

    /* Board */
    .board-wrap { display: grid; grid-template-rows: auto auto; gap: 12px; }
    .board { width: 560px; height: 560px; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); border-radius: 12px; overflow: hidden; border: 2px solid #2a2f54; }
    .cell { display: grid; place-items: center; font-size: 36px; user-select: none; }
    .a { background: var(--board-a); color: #111; }
    .b { background: var(--board-b); color: #111; }
    .hl { outline: 3px solid rgba(0,229,255,0.75); outline-offset: -3px; }

    .controls { display: flex; gap: 10px; }
    .status { font-size: 13px; color: var(--muted); margin-top: 6px; }

    .stat {
      display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 10px;
      background: var(--panel-2); border: 1px solid #2a2f54;
    }
    .bar { height: 8px; background: #2a2f54; border-radius: 999px; overflow: hidden; }
    .bar > span { display: block; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    .list { display: grid; gap: 8px; max-height: 260px; overflow: auto; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; background: #262c54; border: 1px solid #2d335c; color: #dfe2ff; font-size: 12px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <h1>Chess AI Dashboard</h1>
    <div class="actions">
      <select id="whiteBot"></select>
      <select id="blackBot"></select>
      <button id="startBtn">‚ñ∂Ô∏è –ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
      <button id="moveBtn" class="secondary">‚è≠Ô∏è –•—ñ–¥</button>
      <button id="stopBtn" class="ghost">‚èπÔ∏è –°—Ç–æ–ø</button>
      <button id="resetBtn" class="ghost">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel">
      <h2>–°—Ç–∞—Ç—É—Å</h2>
      <div class="stat"><div>–°—Ç–∞–Ω —Å–µ—Ä–≤–µ—Ä–∞</div><div id="srvStatus" class="pill">‚Äî</div></div>
      <div class="stat"><div>–•—ñ–¥</div><div id="turn" class="pill">‚Äî</div></div>
      <div class="stat"><div>–†–µ–∑—É–ª—å—Ç–∞—Ç</div><div id="result" class="pill">‚Äî</div></div>
      <div class="stat"><div>–•–æ–¥—ñ–≤</div><div id="moveCount" class="pill">0</div></div>

      <h2 style="margin-top:12px">–ú–æ–¥—É–ª—ñ</h2>
      <div class="list" id="modulesList"></div>
    </section>

    <section class="panel board-wrap">
      <div id="board" class="board" aria-label="chess-board"></div>
      <div class="controls">
        <div class="status mono" id="status">‚Äî</div>
      </div>
    </section>

    <aside class="panel">
      <h2>–Ü–≥—Ä–∏</h2>
      <div class="list" id="games"></div>
      <h2 style="margin-top:12px">–ú–µ—Ç—Ä–∏–∫–∏</h2>
      <div class="list">
        <div class="stat"><div>–§–∞–∑–∞</div><div id="phase" class="pill">‚Äî</div></div>
        <div>
          <div class="bar"><span id="mobBar" style="width:0%"></span></div>
          <div class="status mono">Mobility: <span id="mobility">0</span></div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    const PIECES = {
      'K':'‚ôî','Q':'‚ôï','R':'‚ôñ','B':'‚ôó','N':'‚ôò','P':'‚ôô',
      'k':'‚ôö','q':'‚ôõ','r':'‚ôú','b':'‚ôù','n':'‚ôû','p':'‚ôü'
    };

    const boardEl = document.getElementById('board');
    const startBtn = document.getElementById('startBtn');
    const moveBtn = document.getElementById('moveBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const whiteSel = document.getElementById('whiteBot');
    const blackSel = document.getElementById('blackBot');

    let autoPlayTimer = null;

    function cellAt(r,c){ return document.querySelector(`[data-r="${r}"][data-c="${c}"]`); }

    function drawBoard(boardArray){
      boardEl.innerHTML = '';
      for(let r=0;r<8;r++){
        for(let c=0;c<8;c++){
          const sq = boardArray[r][c];
          const div = document.createElement('div');
          div.className = `cell ${(r+c)%2? 'a' : 'b'}`;
          div.dataset.r = r; div.dataset.c = c;
          if(sq && sq.symbol){ div.textContent = PIECES[sq.symbol] || ''; }
          boardEl.appendChild(div);
        }
      }
    }

    async function api(path, opts){
      const res = await fetch(path, {headers:{'Content-Type':'application/json'}, ...opts});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function refreshStatus(){
      try{
        const stats = await api('/api/stats');
        document.getElementById('phase').textContent = stats.phase;
        document.getElementById('mobility').textContent = stats.legal_moves_count;
        document.getElementById('mobBar').style.width = Math.min(100, stats.legal_moves_count*3) + '%';
        document.getElementById('turn').textContent = stats.turn;
        document.getElementById('result').textContent = stats.result ?? '‚Äî';
        document.getElementById('moveCount').textContent = stats.move_count;
      }catch(e){ /* ignore */ }
    }

    async function refreshBoard(){
      const data = await api('/api/board');
      drawBoard(data.board);
    }

    async function refreshGames(){
      const games = await api('/api/games');
      const wrap = document.getElementById('games');
      wrap.innerHTML='';
      games.slice(0,50).forEach(g=>{
        const row = document.createElement('div');
        row.className = 'stat';
        row.innerHTML = `<div>#${g.id} ‚Ä¢ ${g.result} ‚Ä¢ ${g.moves} moves</div><div class="pill">${g.modules.white} vs ${g.modules.black}</div>`;
        wrap.appendChild(row);
      });
    }

    async function refreshModules(){
      const mods = await api('/api/modules');
      const wrap = document.getElementById('modulesList');
      wrap.innerHTML = '';
      Object.entries(mods).sort((a,b)=>b[1]-a[1]).forEach(([name,count])=>{
        const item = document.createElement('div');
        item.className = 'stat';
        item.innerHTML = `<div>${name}</div><div class="pill">${count}</div>`;
        wrap.appendChild(item);
      });
    }

    async function populateBots(){
      const bots = await api('/api/bots');
      const fill = (sel)=>{
        sel.innerHTML = '';
        bots.forEach(b=>{
          const opt = document.createElement('option');
          opt.value = opt.textContent = b;
          sel.appendChild(opt);
        });
      };
      fill(whiteSel); fill(blackSel);
      whiteSel.value = 'StockfishBot';
      blackSel.value = 'DynamicBot';
    }

    async function startGame(){
      await api('/api/game/start', { method:'POST', body: JSON.stringify({
        white_bot: whiteSel.value, black_bot: blackSel.value, infinite_mode: true
      })});
      document.getElementById('status').textContent = '–ì—Ä–∞ —Ä–æ–∑–ø–æ—á–∞—Ç–∞';
      if(autoPlayTimer) clearInterval(autoPlayTimer);
      autoPlayTimer = setInterval(async ()=>{
        try{ await api('/api/game/move', {method:'POST', body: '{}'}); }catch(e){ /* stop when fails */ }
        await refreshBoard();
        await refreshStatus();
      }, 800);
    }

    async function makeMove(){
      try {
        await api('/api/game/move', { method:'POST', body: '{}' });
        await refreshBoard();
        await refreshStatus();
      } catch (error) {
        // If move fails because no game is active, start a game first
        if (error.message.includes('–ì—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞') || error.message.includes('400') || error.message.includes('BAD REQUEST')) {
          console.log('No active game, starting a new game...');
          await startGame();
          // Try the move again after starting the game
          try {
            await api('/api/game/move', { method:'POST', body: '{}' });
            await refreshBoard();
            await refreshStatus();
          } catch (secondError) {
            console.error('Move failed even after starting game:', secondError);
          }
        } else {
          console.error('Move failed:', error);
        }
      }
    }

    async function stopGame(){
      if(autoPlayTimer) { clearInterval(autoPlayTimer); autoPlayTimer=null; }
      await api('/api/game/stop', { method:'POST', body: '{}' });
      document.getElementById('status').textContent = '–ì—Ä—É –∑—É–ø–∏–Ω–µ–Ω–æ';
    }

    async function resetGame(){
      if(autoPlayTimer) { clearInterval(autoPlayTimer); autoPlayTimer=null; }
      await api('/api/reset', { method:'POST', body: '{}' });
      await refreshBoard();
      await refreshStatus();
      document.getElementById('status').textContent = '–î–æ—à–∫—É —Å–∫–∏–Ω—É—Ç–æ';
    }

    async function health(){
      try{ const h = await api('/health');
        document.getElementById('srvStatus').textContent = 'healthy';
      }catch(e){ document.getElementById('srvStatus').textContent = 'offline'; }
    }

    // Wire buttons
    startBtn.onclick = startGame;
    moveBtn.onclick = makeMove;
    stopBtn.onclick = stopGame;
    resetBtn.onclick = resetGame;

    // Boot
    (async function init(){
      await health();
      await populateBots();
      await refreshGames();
      await refreshModules();
      await refreshBoard();
      await refreshStatus();
      setInterval(refreshGames, 5000);
      setInterval(refreshModules, 7000);
    })();
  </script>
</body>
</html>
